@page "/Administration/UserMgt"
@inject Microsoft.Extensions.Localization.IStringLocalizer<App> Localize
@inject DataService DS
@inject SessionData SD
@inject IJSRuntime JSRuntime
@using BioMap

<Row>
  <Column>
    <Card Margin="Margin.Is4.OnY">
      <CardHeader>
        <CardTitle>@Localize["Register"]</CardTitle>
      </CardHeader>
      <CardBody>
        <Validations @ref="validations" Mode="ValidationMode.Manual">
          <Validation Validator="@ValidationRule.IsEmail">
            <Field Horizontal="true">
              <FieldLabel ColumnSize="ColumnSize.IsFull.OnTablet.Is2.OnDesktop">@Localize["EMail address"]</FieldLabel>
              <FieldBody ColumnSize="ColumnSize.IsFull.OnTablet.Is10.OnDesktop">
                <TextEdit Role="TextRole.Email" Placeholder="myname@example.com" @bind-Text="SD.CurrentUser.EMail">
                  <Feedback>
                    <ValidationError />
                  </Feedback>
                </TextEdit>
              </FieldBody>
            </Field>
          </Validation>
          <Validation Validator="@ValidationRule.IsNotEmpty">
            <Field Horizontal="true">
              <FieldLabel ColumnSize="ColumnSize.IsFull.OnTablet.Is2.OnDesktop">@Localize["Full name"]</FieldLabel>
              <FieldBody ColumnSize="ColumnSize.IsFull.OnTablet.Is10.OnDesktop">
                <TextEdit Placeholder="John Doe" @bind-Text="SD.CurrentUser.FullName">
                  <Feedback>
                    <ValidationError />
                  </Feedback>
                </TextEdit>
              </FieldBody>
            </Field>
          </Validation>
        </Validations>
        <Field Horizontal="true">
          <FieldLabel ColumnSize="ColumnSize.IsFull.OnTablet.Is2.OnDesktop">
            <Button Color="Color.Primary" Disabled="TanRequested" Clicked="@((e)=>RequestTAN_Clicked())">
              @Localize["Request TAN"]
              @if (TanRequested) {
                <BarIcon IconName="IconName.Check" />
              }
            </Button>
          </FieldLabel>
          <FieldBody ColumnSize="ColumnSize.IsFull.OnTablet.Is10.OnDesktop">
            <TextEdit Placeholder=@Localize["Insert TAN"] @bind-Text="TAN">
            </TextEdit>
          </FieldBody>
        </Field>
        <Field Horizontal="true">
          <FieldLabel ColumnSize="ColumnSize.IsFull.OnTablet.Is2.OnDesktop">
            <Check TValue="bool" @bind-Checked="UserAcknowledgeTerms">
              <ChildContent>
                @Localize["I confirm that I have read and agree with the privacy policy."]
              </ChildContent>
            </Check>
          </FieldLabel>
          <FieldBody ColumnSize="ColumnSize.IsFull.OnTablet.Is10.OnDesktop">
            <Button Color="Color.Primary" Disabled="TanConfirmed || !UserAcknowledgeTerms || TAN==null || TAN.Trim().Length!=9" Clicked="@((e) => ConfirmTAN_Clicked())">
              @Localize["Confirm TAN"]
              @if (TanConfirmed) {
                <BarIcon IconName="IconName.Check" />
              }
            </Button>
          </FieldBody>
        </Field>
        <Field Horizontal="true">
          <FieldLabel ColumnSize="ColumnSize.IsFull.OnTablet.Is2.OnDesktop">@Localize["Access level"]</FieldLabel>
          <FieldBody ColumnSize="ColumnSize.IsFull.OnTablet.Is10.OnDesktop">
            <TextEdit Text="@SD.CurrentUser.Level.ToString()" Plaintext="true" ReadOnly="true" />
          </FieldBody>
        </Field>
      </CardBody>
    </Card>
  </Column>
</Row>

@code {
  private Validations validations;
  private string TAN;
  private bool UserAcknowledgeTerms {
    get {
      return _UserAcknowledgeTerms;
    }
    set {
      if (value!=_UserAcknowledgeTerms) {
        _UserAcknowledgeTerms=value;
        StateHasChanged();
      }
    }
  }
  private bool _UserAcknowledgeTerms = false;

  private bool TanRequested = false;
  private bool TanConfirmed = false;

  private async void RequestTAN_Clicked() {
    if (validations.ValidateAll()) {
      validations.ClearAll();
      await JSRuntime.InvokeVoidAsync("setCookie",new[] { "UserId",SD.CurrentUser.EMail?.Trim() });
      TanRequested=DS.RequestTAN(SD.CurrentUser.EMail?.Trim(),SD.CurrentUser.FullName?.Trim());
    }
    StateHasChanged();
  }
  private async void ConfirmTAN_Clicked() {
    if (validations.ValidateAll()) {
      validations.ClearAll();
      string sPermTicket = DS.ConfirmTAN(SD.CurrentUser.EMail,TAN?.Trim());
      await JSRuntime.InvokeVoidAsync("setCookie",new[] { "UserPermTicket",sPermTicket });
      SD.CurrentUser.Level=DS.GetUserLevel(SD.CurrentUser.EMail,sPermTicket);
      if (SD.CurrentUser.Level>=100) {
        TanConfirmed=true;
      }
    }
    StateHasChanged();
  }
}
