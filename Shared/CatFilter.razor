@inject Microsoft.Extensions.Localization.IStringLocalizer<App> Localize
@using Microsoft.AspNetCore.Components.Forms
@inject DataService DS
@inject SessionData SD
@inject IJSRuntime JSRuntime
@using BioMap

<Field>
  <Row>
    <Column ColumnSize="ColumnSize.Is6">
      <Label>@Localize["Category filter"]</Label>
    </Column>
    <Column ColumnSize="ColumnSize.Is3">
      <Switch Color="Color.Warning" TValue="bool" Checked="@GetInvert()" CheckedChanged="@((e)=>InvertedChanged(e))">@Localize["Invert"]</Switch>
    </Column>
    @*<Column ColumnSize="ColumnSize.Is2">
      <Button Size="Size.Small" Color="Color.Primary" Clicked="@((e)=>Clear())">@Localize["Clear"]</Button>
    </Column>*@
  </Row>
  <Row>
    <Column>
      <Select TValue="int" Multiple="true" MaxVisibleItems="5" SelectedValues="@GetCurrentCatFilter()" SelectedValuesChanged="@((e)=>SelectedValuesChanged(e))">
        @foreach (var cat in Element.Category.AllCategories) {
          <SelectItem Value="@cat.Num">@cat.Num - @cat.Name</SelectItem>
        }
      </Select>
    </Column>
  </Row>
  <FieldHelp>
    @Localize["Select one or more. Negate by switch."]
  </FieldHelp>
</Field>

@code {
    [Parameter]
    public EventCallback<EventArgs> OnAnyChangedCallback { get; set; }
    //
    private void Clear() {
      this.Invert=false;
      this.SelectedValues=null;
      this.AnyValueChanged();
      //base.InvokeAsync(StateHasChanged);
    }
  private bool Invert = false;
  private void InvertedChanged(bool e) {
    this.Invert=e;
    this.AnyValueChanged();
  }
  private IReadOnlyList<int> SelectedValues = new int[0];
  private void SelectedValuesChanged(IReadOnlyList<int> e) {
    this.SelectedValues=e;
    this.AnyValueChanged();
  }
  private void AnyValueChanged() {
    var sb = new System.Text.StringBuilder();
    if (this.SelectedValues!=null && this.SelectedValues.Count>=1) {
      if (this.Invert) {
        sb.Append("-");
      }
      for (int i = 0;i<this.SelectedValues.Count;i++) {
        if (i!=0) {
          sb.Append(" ");
        }
        sb.Append(ConvInvar.ToString(this.SelectedValues[i]));
      }
    } else {
      this.Invert=false;
    }
    SD.Filters.CatFilter=sb.ToString();
    this.OnAnyChangedCallback.InvokeAsync(EventArgs.Empty);
  }
  private bool GetInvert() {
    string sCatFilter = SD.Filters.CatFilter;
    return (this.Invert=sCatFilter.StartsWith("-"));
  }
  private IReadOnlyList<int> GetCurrentCatFilter() {
    string sCatFilter = SD.Filters.CatFilter;
    if (sCatFilter.StartsWith("-")) {
      sCatFilter=sCatFilter.Substring(1);
    }
    var l = new List<int>();
    foreach (var s in sCatFilter.Split(' ')) {
      if (!string.IsNullOrEmpty(s)) {
        l.Add(ConvInvar.ToInt(s));
      }
    }
    return this.SelectedValues=l;
  }
}