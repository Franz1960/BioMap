@inject Microsoft.Extensions.Localization.IStringLocalizer<App> Localize
@using Microsoft.AspNetCore.Components.Forms
@inject DataService DS
@inject SessionData SD
@inject IJSRuntime JSRuntime
@using BioMap

<Row>
  <Column>
    <Field Horizontal="true">
      <FieldLabel ColumnSize="ColumnSize.IsFull.OnTablet.Is3.OnDesktop">@Localize["Category filter"]</FieldLabel>
      <FieldBody ColumnSize="ColumnSize.IsFull.OnTablet.Is9.OnDesktop">
        <Addons>
          <Addon AddonType="AddonType.Start">
            <Dropdown @ref="dropdown">
              <Button Color="Color.Primary" Clicked="@dropdown.Toggle"><Icon Name="IconName.AngleDown" /></Button>
              <DropdownMenu>
                <DropdownItem Clicked="@((e)=>{SD.Filters.CatFilter="";dropdown.Hide();})"><Icon Name="IconName.Clear" /> @Localize["Clear"]</DropdownItem>
                <DropdownDivider Style="min-width:420px"></DropdownDivider>
                @foreach (var category in Element.Category.AllCategories) {
                  <Button Color="SD.Filters.CatFilter.Contains(category.NumString)?Color.Primary:Color.Light" 
                          Class="small" 
                          Style="width:200px;height:50px;overflow:hidden;text-wrap:none;"
                          Clicked="(e)=>ToggleCat(category.NumString)">
                    @(category.NumString+" - "+category.Name)
                  </Button>
                }
              </DropdownMenu>
            </Dropdown>
          </Addon>
          <Addon AddonType="AddonType.Body">
            <TextEdit @bind-Text="SD.Filters.CatFilter" />
          </Addon>
        </Addons>
      </FieldBody>
    </Field>
  </Column>
</Row>

@code {
  Dropdown dropdown;
  private void ToggleCat(string sCatNum) {
    var lCats = new List<string>(SD.Filters.CatFilter.Split(Filters.SeparateChars));
    int idx = lCats.IndexOf(sCatNum);
    if (idx<0) {
      lCats.Add(sCatNum);
    } else {
      lCats.RemoveAt(idx);
    }
    lCats.Sort();
    var sb = new System.Text.StringBuilder();
    lCats.ForEach((p) => sb.Append(p+" "));
    SD.Filters.CatFilter=sb.ToString().Trim();
  }
}
