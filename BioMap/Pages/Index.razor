@page "/"
@inject Microsoft.Extensions.Localization.IStringLocalizer<App> Localize
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@inject DataService DS
@inject SessionData SD
@using BioMap

<Row>
  <Column>
    <Card Margin="Margin.Is4.OnY">
      <CardHeader>
        <CardTitle Size="4">@Localize["Welcome to BioMap!"]</CardTitle>
      </CardHeader>
      <CardImage Source="images/TitlePage.jpg"/>
      <CardBody>
        <p>@Localize["BioMap helps monitor yellow-bellied toads."]</p>
      </CardBody>
    </Card>
  </Column>
</Row>
<Row Margin="Margin.Is4.OnY">
  @if (SD.CurrentUser.Level<200) {
    <Column>
      <Card>
        <CardHeader>
          <CardTitle>@Localize["Register"]</CardTitle>
        </CardHeader>
        <CardBody>
          <CardText>
            @Localize["You can look around the website without registration. However, you will only see alienated location coordinates. If you want to see unaltered data and participate in the project, you are welcome to register."]
          </CardText>
          <Button Color="Color.Primary" Clicked="@((e) => NavigationManager.NavigateTo("/Administration/UserMgt"))">@Localize["Register"]</Button>
        </CardBody>
      </Card>
    </Column>
  }
  <Column>
    <Card>
      <CardHeader>
        <CardTitle>@Localize["Project"]</CardTitle>
      </CardHeader>
      <CardBody>
        <Field Horizontal="true">
          <FieldLabel ColumnSize="ColumnSize.IsFull.OnTablet.Is6.OnDesktop">@Localize["Select project"]</FieldLabel>
          <FieldBody ColumnSize="ColumnSize.IsFull.OnTablet.Is6.OnDesktop">
            <Select TValue="string" SelectedValue="@SD.CurrentUser.Project" SelectedValueChanged="@(async (e)=>{ await Project_SelectedValueChanged(e); })">
              @foreach (var sProject in DS.GetAllProjects()) {
                <SelectItem TValue="string" Value="@(sProject)">@sProject</SelectItem>
              }
            </Select>
          </FieldBody>
        </Field>
      </CardBody>
    </Card>
  </Column>
</Row>

@code {
  protected override Task OnInitializedAsync() {
    return base.OnInitializedAsync();
  }
  protected override async Task OnAfterRenderAsync(bool firstRender) {
    if (!DS.IsMigrationInProcess && firstRender) {
      bool bAnyChanged = false;
      try {
        SD.CurrentUser.Project = await JSRuntime.InvokeAsync<string>("getCookie","Project");
        var sEMail = await JSRuntime.InvokeAsync<string>("getCookie","UserId");
        var sUserId = sEMail.Trim().ToLowerInvariant();
        if (string.CompareOrdinal(sEMail,sUserId)!=0) {
          await JSRuntime.InvokeAsync<string>("setCookie","UserId",sUserId);
          sEMail=sUserId;
        }
        if (string.CompareOrdinal(sEMail,SD.CurrentUser.EMail)!=0) {
          SD.CurrentUser.EMail = sEMail;
          bAnyChanged=true;
        }
        var sUserPermTicket = await JSRuntime.InvokeAsync<string>("getCookie","UserPermTicket."+SD.CurrentUser.Project);
        var user = new User();
        DS.LoadUser(SD,sUserPermTicket,user);
        if (!object.Equals(user,SD.CurrentUser)) {
          DS.LoadUser(SD,sUserPermTicket,SD.CurrentUser);
          bAnyChanged=true;
        }
      } catch { }
      if (bAnyChanged) {
        StateHasChanged();
      }
    }
  }
  private async Task Project_SelectedValueChanged(string sNewValue) {
    if (sNewValue==null) {
      sNewValue="";
    }
    SD.CurrentUser.Project=sNewValue;
    await JSRuntime.InvokeAsync<string>("setCookie","Project",sNewValue);
    NavigationManager.NavigateTo("/",true);
  }
}
